---
interface Props {
  redirectTo?: string;
}
const { redirectTo = '/dashboard' } = Astro.props;
---

<div id="auth-root">
  <div id="auth-loading" class="flex min-h-[40vh] items-center justify-center">
    <div class="flex flex-col items-center gap-4">
      <div class="h-10 w-10 animate-spin rounded-full border-2 border-primary border-t-transparent" />
      <p class="text-sm text-gray-500">Φόρτωση...</p>
    </div>
  </div>
  <div id="auth-login" class="hidden mx-auto max-w-sm rounded-2xl border border-gray-200 bg-white p-8 shadow-card">
    <h2 class="text-xl font-semibold text-dark">Σύνδεση</h2>
    <p class="mt-1 text-sm text-gray-500">Συνδεθείτε για να δείτε το SEO Report.</p>
    <form id="login-form" class="mt-6 space-y-4">
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
        <input
          id="email"
          type="email"
          required
          autocomplete="email"
          class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
          placeholder="you@example.com"
        />
      </div>
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">Κωδικός</label>
        <input
          id="password"
          type="password"
          required
          autocomplete="current-password"
          class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
        />
      </div>
      <p id="login-error" class="hidden text-sm text-red-600"></p>
      <button
        type="submit"
        id="login-submit"
        class="w-full rounded-lg bg-primary px-4 py-2.5 text-sm font-medium text-white transition hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
      >
        Σύνδεση
      </button>
    </form>
  </div>
  <div id="auth-content" class="hidden">
    <slot />
  </div>
</div>

<script>
  import { auth, isFirebaseConfigured } from '../lib/firebase';
  import { onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'firebase/auth';

  const loadingEl = document.getElementById('auth-loading');
  const loginEl = document.getElementById('auth-login');
  const contentEl = document.getElementById('auth-content');
  const loginForm = document.getElementById('login-form') as HTMLFormElement;
  const loginError = document.getElementById('login-error');

  function showLoading() {
    if (loadingEl) loadingEl.classList.remove('hidden');
    if (loginEl) loginEl.classList.add('hidden');
    if (contentEl) contentEl.classList.add('hidden');
  }

  function showLogin() {
    if (loadingEl) loadingEl.classList.add('hidden');
    if (loginEl) loginEl.classList.remove('hidden');
    if (contentEl) contentEl.classList.add('hidden');
  }

  function showContent() {
    if (loadingEl) loadingEl.classList.add('hidden');
    if (loginEl) loginEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
  }

  // Λειτουργία mockup: χωρίς Firebase config εμφανίζουμε αμέσως το dashboard
  if (!isFirebaseConfigured || !auth) {
    showContent();
  } else {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        showContent();
      } else {
        showLogin();
      }
    });
  }

  document.getElementById('auth-root')?.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).id === 'logout-btn' && auth) {
      signOut(auth);
    }
  });

  if (loginForm && auth) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = (document.getElementById('email') as HTMLInputElement).value;
      const password = (document.getElementById('password') as HTMLInputElement).value;
      if (loginError) loginError.classList.add('hidden');
      const btn = document.getElementById('login-submit') as HTMLButtonElement;
      if (btn) btn.disabled = true;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err: unknown) {
        const message = err instanceof Error ? err.message : 'Σφάλμα σύνδεσης';
        if (loginError) {
          loginError.textContent = message;
          loginError.classList.remove('hidden');
        }
      } finally {
        if (btn) btn.disabled = false;
      }
    });
  }
</script>
