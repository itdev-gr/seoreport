---
interface Props {
  redirectTo?: string;
}
const { redirectTo = '/dashboard' } = Astro.props;
---

<div id="auth-root">
  <div id="auth-setup-banner" class="hidden border-b border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800" role="alert">
    Ρύθμιση server: πρόσθεσε <strong>FIREBASE_SERVICE_ACCOUNT_JSON</strong> στο αρχείο <code>.env</code> (βλ. .env.example) και κάνε restart το server.
  </div>
  <div id="auth-loading" class="flex min-h-[40vh] items-center justify-center">
    <div class="flex flex-col items-center gap-4">
      <div class="h-10 w-10 animate-spin rounded-full border-2 border-primary border-t-transparent" />
      <p class="text-sm text-gray-500">Φόρτωση...</p>
    </div>
  </div>
  <div id="auth-content" class="hidden">
    <slot />
  </div>
</div>

<script>
  import { auth, isMockupMode } from '../lib/firebase';
  import { onAuthStateChanged, signOut } from 'firebase/auth';

  const loadingEl = document.getElementById('auth-loading');
  const contentEl = document.getElementById('auth-content');

  console.log('[Firebase] AuthWrapper: isMockupMode', isMockupMode, 'auth', auth ? 'exists' : 'null');

  function showLoading() {
    if (loadingEl) loadingEl.classList.remove('hidden');
    if (contentEl) contentEl.classList.add('hidden');
  }

  function showContent() {
    if (loadingEl) loadingEl.classList.add('hidden');
    if (contentEl) contentEl.classList.remove('hidden');
  }

  if (isMockupMode) {
    showContent();
  } else if (auth) {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('[Firebase] AuthWrapper: user signed in');
        showContent();
        // Ensure user exists in Firestore (check + create if missing) on every protected page load
        user.getIdToken().then((token) => {
          fetch('/api/user/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          }).then((res) => {
            const banner = document.getElementById('auth-setup-banner');
            if (banner && res.status === 503) banner.classList.remove('hidden');
          }).catch(() => {});
        }).catch(() => {});
      } else {
        console.log('[Firebase] AuthWrapper: no user, redirect to /login');
        window.location.href = '/login';
      }
    });
  } else {
    console.log('[Firebase] AuthWrapper: no auth, redirect to /login');
    window.location.href = '/login';
  }

  document.getElementById('auth-root')?.addEventListener('click', (e) => {
    if ((e.target as HTMLElement).id === 'logout-btn' && auth) {
      console.log('[Firebase] Logout clicked, calling signOut');
      signOut(auth);
      console.log('[Firebase] signOut called');
    }
  });
</script>
