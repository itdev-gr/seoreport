---
// Πρώτη εμφάνιση: build-time options (θα αντικατασταθούν client-side για πάντα ενημερωμένη λίστα)
import { getPeriodOptions } from '../lib/periods';
const initialOptions = getPeriodOptions();
const initialLabel = initialOptions[0]?.label ?? 'Επιλογή περιόδου';
---

<div class="period-selector relative" data-period-selector>
  <label for="period-trigger" class="block text-xs font-semibold uppercase tracking-wider text-white mb-1.5">
    ΑΝΑΦΟΡΑ ΓΙΑ
  </label>
  <button
    type="button"
    id="period-trigger"
    aria-haspopup="listbox"
    aria-expanded="false"
    aria-label="Επιλογή περιόδου"
    class="flex min-w-[240px] items-center justify-between gap-2 rounded-lg bg-dark/60 border border-white/20 px-4 py-2.5 text-left text-sm font-medium text-white shadow-sm transition hover:bg-dark/70 focus:outline-none focus:ring-2 focus:ring-white/40"
  >
    <span id="period-label">{initialLabel}</span>
    <svg id="period-chevron" class="h-4 w-4 shrink-0 text-white/90 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>
  <div
    id="period-dropdown"
    role="listbox"
    aria-hidden="true"
    class="absolute left-0 top-full z-[100] mt-1 max-h-[320px] min-w-[280px] overflow-y-auto rounded-lg border border-gray-200 bg-white py-1 shadow-xl hidden"
  >
    <!-- Τα options γεμίζουν client-side από τρέχουσα ημερομηνία (όλοι οι μήνες, ανανέωση κάθε μήνα) -->
  </div>
</div>

<script>
  import { getPeriodOptions } from '../lib/periods';

  const selector = document.querySelector('[data-period-selector]');
  const trigger = document.getElementById('period-trigger');
  const labelEl = document.getElementById('period-label');
  const dropdown = document.getElementById('period-dropdown');

  function renderPeriodOptions() {
    if (!dropdown || !labelEl) return;
    const options = getPeriodOptions(); // Τρέχουσα ημερομηνία στο browser → πάντα ενημερωμένοι μήνες
    dropdown.innerHTML = '';
    options.forEach((opt, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.setAttribute('role', 'option');
      btn.dataset.periodValue = opt.value;
      btn.dataset.periodLabel = opt.label;
      btn.className = 'w-full px-4 py-2.5 text-left text-sm text-dark hover:bg-primary/10 focus:bg-primary/10 focus:outline-none data-[selected]:bg-primary/15 data-[selected]:font-medium';
      if (index === 0) btn.setAttribute('data-selected', 'true');
      btn.textContent = opt.label;
      dropdown.appendChild(btn);
    });
    if (options[0] && labelEl) labelEl.textContent = options[0].label;
  }

  function attachOptionListeners() {
    dropdown?.querySelectorAll('[role="option"]').forEach((opt) => {
      opt.addEventListener('click', () => {
        const value = (opt as HTMLElement).dataset.periodValue;
        const label = (opt as HTMLElement).dataset.periodLabel;
        if (label) labelEl!.textContent = label;
        dropdown?.querySelectorAll('[role="option"]').forEach((o) => o.removeAttribute('data-selected'));
        opt.setAttribute('data-selected', 'true');
        dropdown?.classList.add('hidden');
        trigger?.setAttribute('aria-expanded', 'false');
        document.getElementById('period-chevron')?.classList.remove('rotate-180');
        window.dispatchEvent(new CustomEvent('period-change', { detail: { value, label } }));
      });
    });
  }

  if (selector && trigger && labelEl && dropdown) {
    renderPeriodOptions();
    attachOptionListeners();

    const chevron = document.getElementById('period-chevron');
    trigger.addEventListener('click', () => {
      const isOpen = dropdown.classList.contains('hidden');
      dropdown.classList.toggle('hidden', !isOpen);
      trigger.setAttribute('aria-expanded', String(isOpen));
      chevron?.classList.toggle('rotate-180', isOpen);
    });

    document.addEventListener('click', (e) => {
      if (!selector?.contains(e.target as Node)) {
        dropdown.classList.add('hidden');
        trigger.setAttribute('aria-expanded', 'false');
        document.getElementById('period-chevron')?.classList.remove('rotate-180');
      }
    });
  }
</script>
