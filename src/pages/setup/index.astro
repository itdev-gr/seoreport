---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Setup - SEO Report - IT DEV" showHeader={true}>
  <div slot="header-actions" class="flex flex-wrap items-center gap-3">
    <a href="/dashboard" class="rounded-lg bg-white/20 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
      ← Dashboard
    </a>
    <a href="/admin" class="rounded-lg bg-white/20 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/50">
      Λίστα πελατών →
    </a>
  </div>

  <div class="rounded-xl border border-gray-200 bg-white shadow-card overflow-hidden">
    <section>
      <div class="border-b border-gray-100 px-6 py-4">
        <h2 class="text-lg font-semibold text-dark">Προσθήκη νέου πελάτη</h2>
        <p class="mt-0.5 text-sm text-gray-500">Ορίστε email και κωδικό (Firebase Auth). Το Search Console ID το παίρνετε από το URL του Google Search Console (resource_id). Ο πελάτης θα κάνει login με αυτά τα στοιχεία.</p>
      </div>
      <form id="add-client-form" class="p-6 space-y-4">
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label for="client-email" class="block text-sm font-medium text-gray-700">Email *</label>
            <input id="client-email" name="email" type="email" required placeholder="πελατης@example.com"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:ring-1 focus:ring-primary" />
          </div>
          <div>
            <label for="client-password" class="block text-sm font-medium text-gray-700">Κωδικός (που ορίζετε εσείς) *</label>
            <input id="client-password" name="password" type="password" required minlength="6" placeholder="••••••••"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:ring-1 focus:ring-primary" />
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label for="client-name" class="block text-sm font-medium text-gray-700">Όνομα πελάτη</label>
            <input id="client-name" name="name" type="text" placeholder="Όνομα εταιρείας"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:ring-1 focus:ring-primary" />
          </div>
          <div>
            <label for="client-search-console-id" class="block text-sm font-medium text-gray-700">Search Console ID *</label>
            <input id="client-search-console-id" name="searchConsoleId" type="text" required
              placeholder="sc-domain:example.com ή https://www.example.com/"
              class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:ring-1 focus:ring-primary" />
            <p class="mt-1 text-xs text-gray-500">Από το URL του GSC: resource_id (domain property: <code class="bg-gray-100 px-1 rounded">sc-domain:example.com</code>, URL prefix: πλήρης URL).</p>
          </div>
        </div>
        <div>
          <label for="client-domain" class="block text-sm font-medium text-gray-700">Domain (προαιρετικό, για εμφάνιση)</label>
          <input id="client-domain" name="domain" type="text" placeholder="example.com"
            class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 text-dark shadow-sm focus:border-primary focus:ring-1 focus:ring-primary" />
        </div>
        <p id="add-client-message" class="hidden text-sm"></p>
        <button type="submit" id="add-client-submit" class="rounded-lg bg-primary px-4 py-2.5 text-sm font-medium text-white transition hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2">
          Δημιουργία πελάτη
        </button>
      </form>
    </section>
  </div>
</Layout>

<script>
  import { auth } from '../../lib/firebase';

  const form = document.getElementById('add-client-form') as HTMLFormElement;
  const messageEl = document.getElementById('add-client-message') as HTMLParagraphElement;
  const submitBtn = document.getElementById('add-client-submit') as HTMLButtonElement;

  function showMessage(text: string, isError: boolean) {
    if (!messageEl) return;
    messageEl.textContent = text;
    messageEl.classList.remove('hidden', 'text-green-600', 'text-red-600');
    messageEl.classList.add(isError ? 'text-red-600' : 'text-green-600');
  }

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = (form.querySelector('[name="email"]') as HTMLInputElement).value.trim();
      const password = (form.querySelector('[name="password"]') as HTMLInputElement).value;
      const name = (form.querySelector('[name="name"]') as HTMLInputElement).value.trim();
      const searchConsoleId = (form.querySelector('[name="searchConsoleId"]') as HTMLInputElement).value.trim();
      const domain = (form.querySelector('[name="domain"]') as HTMLInputElement).value.trim();
      if (!email || !password || !searchConsoleId) {
        showMessage('Συμπληρώστε email, κωδικό και Search Console ID.', true);
        return;
      }
      const token = auth?.currentUser ? await auth.currentUser.getIdToken() : null;
      if (!token) {
        showMessage('Παρακαλώ συνδεθείτε.', true);
        return;
      }
      if (submitBtn) submitBtn.disabled = true;
      showMessage('Δημιουργία πελάτη...', false);
      try {
        const res = await fetch('/api/create-client', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ email, password, name: name || undefined, searchConsoleId, domain: domain || undefined }),
        });
        const data = await res.json();
        if (res.status === 403) {
          showMessage('Δεν έχετε δικαιώματα. Μόνο admins μπορούν να δημιουργήσουν πελάτη.', true);
          return;
        }
        if (!res.ok) throw new Error(data.error || 'Σφάλμα');
        showMessage(`Ο πελάτης δημιουργήθηκε. Report: /report/${data.client.id}`, false);
        form.reset();
      } catch (err) {
        showMessage(err instanceof Error ? err.message : 'Σφάλμα δημιουργίας πελάτη', true);
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    });
  }
</script>
