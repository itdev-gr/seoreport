---
import Layout from '../layouts/Layout.astro';
import PeriodSelector from '../components/PeriodSelector.astro';
import DashboardContent from '../components/DashboardContent.astro';
import { fetchDashboardData } from '../lib/search-console';
import AuthWrapper from '../components/AuthWrapper.astro';

const data = await fetchDashboardData({ period: 'Τελευταίος Μήνας' });
---

<Layout title="SEO Report - IT DEV" showHeader={true}>
  <div slot="header-actions" class="flex flex-wrap items-end gap-4">
    <div id="admin-links-container" class="hidden shrink-0 items-center gap-3"></div>
    <PeriodSelector />
    <button
      type="button"
      id="export-pdf"
      class="rounded-lg bg-white/20 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 shrink-0"
    >
      Εξαγωγή PDF
    </button>
  </div>

  <AuthWrapper>
    <DashboardContent data={{ metrics: data.metrics, topKeywords: data.topKeywords, topPages: data.topPages }} />
  </AuthWrapper>
</Layout>

<script>
  import { auth } from '../lib/firebase';
  import { onAuthStateChanged } from 'firebase/auth';

  const container = document.getElementById('admin-links-container');
  if (container && auth) {
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      const token = await user.getIdToken();
      try {
        const res = await fetch('/api/me', { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 503) {
          document.getElementById('auth-setup-banner')?.classList.remove('hidden');
          return;
        }
        if (!res.ok) return;
        const data = await res.json();
        if (data.role === 'admin') {
          container.classList.remove('hidden');
          container.classList.add('flex');
          container.innerHTML = `
            <a href="/admin" class="rounded-lg bg-white/20 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 shrink-0">Admin</a>
            <a href="/setup" class="rounded-lg bg-white/20 px-4 py-2.5 text-sm font-medium text-white transition hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-white/50 shrink-0">Προσθήκη πελάτη</a>
          `;
        }
      } catch {
        // ignore
      }
    });
  }
</script>
